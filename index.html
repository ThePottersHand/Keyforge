<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KeforgeRandom</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:,">
<style>
:root{
  --bg:#121212; --card:#1e1e1e; --text:#e0e0e0;
  --primary:#d32f2f; --success:#4caf50; --errata:#ff5252;
  --pinned:#ffeb3b;
  --tab-bg:#2a2a2a; --tab-active:#3a3a3a;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);padding:20px;line-height:1.6;}
.container{max-width:1100px;margin:auto;}
h1{color:#ffeb3b;text-align:center;margin-bottom:16px;font-size:2rem;}

/* ACTION BAR */
.action-bar{
  background:var(--card);padding:12px 16px;border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.4);margin-bottom:16px;
  display:flex;gap:12px;align-items:center;flex-wrap:wrap;
}
.action-bar label{font-weight:bold;font-size:0.95rem;}
.action-bar select{padding:8px;border-radius:8px;font-size:15px;flex:1 1 100px;}
.action-bar button{
  background:var(--primary);color:white;padding:10px 18px;
  border:none;border-radius:8px;font-weight:bold;cursor:pointer;transition:.3s;
  font-size:15px;flex:1 1 140px;
}
.action-bar button:hover{background:#b71c1c;}
.action-bar button:disabled{background:#666;cursor:not-allowed;}
@media(max-width:600px){
  .action-bar{flex-direction:column;gap:10px;}
  .action-bar select,.action-bar button{flex:1 1 100%;}
}

/* TABS */
.tabs{
  display:flex;gap:2px;margin-bottom:16px;
  border-bottom:1px solid #444;
}
.tab{
  background:var(--tab-bg);padding:10px 16px;cursor:pointer;
  border-radius:8px 8px 0 0;font-weight:bold;font-size:0.95rem;
  transition:.3s;
}
.tab.active{background:var(--tab-active);border-bottom:2px solid var(--primary);}

/* TAB CONTENT */
.tab-content{display:none;}
.tab-content.active{display:block;}

/* FILTER SECTION */
.filter-section{
  background:var(--card);border-radius:12px;margin-bottom:16px;
  box-shadow:0 4px 12px rgba(0,0,0,.4);padding:16px;
}
.filter-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.filter-col{flex:1;}
label{display:block;margin:10px 0 5px;font-weight:bold;font-size:0.95rem;}
select,input{width:100%;padding:8px;margin:4px 0;border:none;border-radius:8px;font-size:15px;}
input[type="number"]{width:100%;}
select[multiple]{height:120px;background:#2a2a2a;color:white;}
.btn-small{display:inline-block;width:auto;padding:5px 10px;margin:3px 2px;font-size:13px;border-radius:8px;}
.btn-success{background:var(--success);color:white;}
.btn-success:hover{background:#388e3c;}

/* FILTERED COUNT */
.filter-count{color:#ffeb3b;font-style:italic;text-align:center;margin:8px 0;font-size:0.9rem;}

/* DECK REVIEW LIST */
.deck-review-list{
  display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:12px;
}
.deck-item{
  background:var(--card);padding:12px;border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.3);cursor:pointer;
  transition:.2s;
}
.deck-item:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.4);}
.deck-item h3{font-size:1.05rem;margin:0 0 4px;display:flex;align-items:center;gap:6px;}
.deck-item p{font-size:0.85rem;color:#bbb;margin:2px 0;}
.deck-item .errata-tag{color:var(--errata);font-weight:bold;}

/* DECK (COLLAPSIBLE) */
.deck{background:var(--card);border-radius:12px;margin:16px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);}
.deck-header{cursor:pointer;padding:14px 18px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:flex-start;}
.deck-header .info{flex:1;}
.deck-header h2{margin:0 0 3px 0;font-size:1.4rem;font-weight:bold;display:flex;align-items:center;gap:6px;}
.deck-header .errata-tag{color:var(--errata);font-weight:bold;font-size:1rem;}
.deck-header .deck-info{color:#bbb;font-size:0.9rem;margin:3px 0 0 0;}
.deck-header .links{margin-top:6px;}
.deck-header .links a{color:#90caf9;text-decoration:none;font-size:0.85rem;margin-right:16px;}
.deck-header .links a:hover{text-decoration:underline;}
.deck-header .pin-btn{
  background:var(--pinned);color:#000;padding:6px 10px;
  border:none;border-radius:6px;font-size:0.8rem;cursor:pointer;
  font-weight:bold;opacity:0.7;transition:.2s;
}
.deck-header .pin-btn.pinned{opacity:1;background:#ffeb3b;}
.deck-header .pin-btn:hover{opacity:1;}
.deck-header::after{content:'expand_more';font-family:'Material Icons';font-size:1.6rem;color:#aaa;margin-left:8px;}
.deck.collapsed .deck-header::after{content:'expand_less';}
.deck-content{max-height:3000px;transition:max-height .5s ease;overflow:hidden;padding:18px;}
.deck.collapsed .deck-content{max-height:0;padding:0 18px;}

/* HOUSE GRID */
.houses-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));gap:16px;}
.house{text-align:center;}
.house img{width:56px;height:56px;border-radius:50%;background:#333;padding:3px;}
.house h3{margin:6px 0 3px;font-size:1.2rem;color:#ffeb3b;}
.house-cards{display:flex;flex-direction:column;gap:5px;text-align:left;}
.card{background:#2a2a2a;padding:5px 8px;border-radius:6px;font-size:0.88rem;}
.errata{color:var(--errata);font-weight:bold;}

/* HOUSE LOGOS IN HEADER */
.house-logo{width:20px;height:20px;border-radius:50%;}

/* MESSAGES */
.message{color:#ff5252;text-align:center;margin:12px 0;font-weight:bold;}

/* MISC */
@media(max-width:600px){
  .filter-grid{grid-template-columns:1fr;}
  .deck-review-list{grid-template-columns:1fr;}
  .deck-header{flex-direction:column;gap:8px;}
  .deck-header .pin-btn{margin-top:4px;}
}
</style>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
<div class="container">
  <h1>KeforgeRandom</h1>

  <!-- ACTION BAR -->
  <div class="action-bar">
    <label>Number of Decks:</label>
    <select id="numDecks">
      <option value="1">1 Deck</option>
      <option value="2" selected>2 Decks</option>
    </select>
    <button id="selectBtn" disabled onclick="pickDecks()">Select Random Deck(s)</button>
  </div>

  <!-- SELECTED DECKS (APPEAR HERE) -->
  <div id="results"></div>

  <!-- MESSAGE -->
  <div id="message" class="message" style="display:none;"></div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active” onclick="openTab('filters')">Filters</div>
    <div class="tab" onclick="openTab('review')">Deck Review</div>
  </div>

  <!-- TAB CONTENT -->
  <div id="filters" class="tab-content active">
    <div class="filter-section">
      <label>SAS Range:</label>
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="number" id="sasMinInput" placeholder="Min" style="flex:1">
        <span style="width:16px;text-align:center;">–</span>
        <input type="number" id="sasMaxInput" placeholder="Max" style="flex:1">
      </div>

      <div id="diffControl" style="margin-top:8px;">
        <label>Max SAS Difference:</label>
        <input type="number" id="maxDiffInput" min="0" max="30" value="5">
      </div>

      <div class="filter-grid">
        <div class="filter-col">
          <label>Sets:</label>
          <div style="display:flex;gap:4px;">
            <button class="btn-small btn-success" onclick="selectAll('sets')">All</button>
            <button class="btn-small" onclick="clearAll('sets')">Clear</button>
          </div>
          <select id="sets" multiple></select>
        </div>
        <div class="filter-col">
          <label>Houses:</label>
          <div style="display:flex;gap:4px;">
            <button class="btn-small btn-success" onclick="selectAll('houses')">All</button>
            <button class="btn-small" onclick="clearAll('houses')">Clear</button>
          </div>
          <select id="houses" multiple></select>
        </div>
      </div>
    </div>
  </div>

  <div id="review" class="tab-content">
    <p class="filter-count" id="filterCount">Loading decks from CSV…</p>
    <div id="deckReviewList" class="deck-review-list"></div>
  </div>
</div>

<script>
/* --------------------------------------------------------------
   GLOBAL STATE
   -------------------------------------------------------------- */
let data = [], filteredData = [], sets = new Set(), houses = new Set();
let minSAS = Infinity, maxSAS = -Infinity;
let selectedDecks = [null, null];  // [deck0, deck1]
let pinnedDecks = [];              // UUIDs of pinned decks

/* --------------------------------------------------------------
   TAB SWITCHING
   -------------------------------------------------------------- */
function openTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`.tab[onclick="openTab('${tabName}')"]`).classList.add('active');
  document.getElementById(tabName).classList.add('active');
  if(tabName === 'review') populateDeckReview();
}

/* --------------------------------------------------------------
   COLLAPSE DECK
   -------------------------------------------------------------- */
function toggleCollapse(header){
  const deck = header.closest('.deck');
  deck.classList.toggle('collapsed');
}

/* --------------------------------------------------------------
   PIN DECK
   -------------------------------------------------------------- */
function togglePin(uuid) {
  const index = pinnedDecks.indexOf(uuid);
  if (index === -1) {
    pinnedDecks.push(uuid);
  } else {
    pinnedDecks.splice(index, 1);
  }
  renderSelectedDecks();
}

/* --------------------------------------------------------------
   SHOW MESSAGE
   -------------------------------------------------------------- */
function showMessage(text, timeout = 3000) {
  const msg = document.getElementById('message');
  msg.textContent = text;
  msg.style.display = 'block';
  setTimeout(() => msg.style.display = 'none', timeout);
}

/* --------------------------------------------------------------
   FULL ERRATA
   -------------------------------------------------------------- */
const ERRATA = {
  "Arcenomometer": "Enhance ÆmberÆmber.\n(These icons have already been added to cards in your deck.)\nAction: During your opponent’s next turn, each time they play a card, they lose 1Æmber.",
  "Auto-Legionary": "Action: Put Auto-Legionary on a flank of your battleline. While in the battleline, it is considered a creature with 5 power and may be used as if it belonged to the active house.",
  "Bait and Switch": "Play: If your opponent has more Æmber than you, steal 1Æmber. Repeat the preceding effect if your opponent still has more Æmber than you.",
  "Biomatrix Backup": "This creature gains,\"Destroyed: Put this creature into its owner's archives.\"",
  "Cauldron": "Omni: Put the top card of your deck faceup under Cauldron. If there are 3 or more cards under Cauldron, play them one at a time as if they were in your hand.",
  "Collector Worm": "After Fight: Put the creature Collector Worm fights into your archives. (Both creatures must survive the fight.) If that creature leaves your archives, put it in its owner's hand instead.",
  "Corner the Market": "Play: During your opponent's next turn, they cannot play cards, and each time they discard a card from their hand, they may archive that card from their discard pile.",
  "Curse of Forgetfulness": "Treachery. (This card enters play under your opponent's control.)\nAt the end of your turn, purge the top card in your discard pile.",
  "Custom Virus": "Omni: Destroy Custom Virus. You may purge a creature from your hand. If you do, destroy each creature that shares a trait with the purged creature.",
  "Drummernaut": "Play/After Fight/After Reap: Return another friendly Giant creature to your hand.",
  "Duskwitch": "Omega. Elusive.\nYour creatures enter play ready.",
  "Ecto-Charge": "Play: Forge a key at +20Æmber current cost, reduced by 1Æmber for each card in your discard pile (to a minimum of 6). If you do, purge Ecto-Charge.",
  "Experimental Therapy": "This creature may be used as if it belonged to the active house.\nPlay: Stun and exhaust this creature.",
  "Glimmerspore": "Play: Put an artifact from play into your archives. If you are not the owner of that card and it leaves your archives, put it into its owner’s hand instead.",
  "Incubation Chamber": "Omni: You may reveal a Mars creature from your hand. If you do, archive it.",
  "Into the Warp": "Play: Each player discards the top card of their deck. Destroy each creature that shares a house with at least one of the discarded cards.",
  "Keyforgery": "When your opponent would forge a key on their turn, that player names a house. Reveal a random card from your hand. If that card is not of the named house, destroy Keyforgery and they do not forge that key (no Æmber is spent).",
  "Library Access": "Play: For the remainder of the turn, each time you play another card, draw a card. Purge Library Access.",
  "Life for a Life": "Play: Destroy a friendly creature. If you do, deal 6 damage to a creature.",
  "Magda the Rat": "Elusive.\nPlay: Steal 2Æmber. If Magda the Rat leaves play, your opponent steals 2Æmber.",
  "Missile Officer Myers": "Deploy.\nPlay/After Reap: Resolve the play effect of a neighboring creature as if you had just played it.\nScrap: You may play 1 card that is not of the active house during your turn.",
  "Offering to Kiligog": "The second “Omni:” ability should read:\nOmni: Make each card under Offering to Kiligog a token creature as if the card was on top of your deck.",
  "Pain Reaction": "Play: Deal 2 damage to an enemy creature. If this damage destroys that creature, deal 2 damage to each of that creature’s neighbors after it leaves play.",
  "Ragatha": "Treachery.\nAfter an enemy creature reaps, deal 3 damage to each of Ragatha’s neighbors.",
  "Sample 42-C": "Action: Move 1Æmber from your opponent’s pool to Sample 42-C. If there are 4Æmber or more on Sample 42-C, forge a key at no cost and purge Sample 42-C.\nFate: The most powerful enemy creature captures half of your Æmber (rounding down).",
  "Scoop Up": "Play: Put a friendly non-Mars creature and an enemy non-Mars creature into your archives. If either card leaves your archives and you are not the owner of it, put it into its owner’s hand instead.",
  "Shrink-ray Technician": "After Reap: Choose an enemy creature. It gets –2 power until the end of the turn.\nScrap: Choose the most powerful enemy creature. Until the end of the turn, that creature is considered to have 1 power and 0 armor.",
  "Space Invaders": "Play: Reveal any number of creatures from your hand. Make each creature revealed this way a token creature as if the card was on top of your deck.",
  "Tendrils of Pain": "Play: Deal 1 damage to each creature. Deal 4 damage to each creature instead if your opponent forged a key on their previous turn.",
  "Yipyax Abductor": "Play/After Fight: Put an upgrade from play into your archives. If you are not the owner of that card and it leaves your archives, put it into its owner’s hand instead.",
  "Yzphyz Knowdrone": "Play: Archive a card. You may purge an archived card. If you do, stun a creature."
};

/* --------------------------------------------------------------
   HOUSE TO ICON MAPPING
   -------------------------------------------------------------- */
const HOUSE_ICON_MAP = {
  "logos": "logos", "sanctum": "sanctum", "shadows": "shadows", "dis": "dis",
  "brobnar": "brobnar", "untamed": "untamed", "mars": "mars", "saurian": "saurian",
  "star": "star-alliance", "staralliance": "star-alliance",
  "unfathomable": "unfathomable", "unfathom": "unfathom",
  "ekwidon": "ekwidon", "geistoid": "geistoid", "redemption": "redemption", "skyborn": "skyborn"
};

/* --------------------------------------------------------------
   CSV PARSER
   -------------------------------------------------------------- */
function parseCSV(text){
  const rows = [];
  let cur = '', inQ = false, field = '';
  for(let i=0;i<text.length;i++){
    const ch = text[i], next = text[i+1];
    if(ch==='"' && text[i-1]!=='\\'){
      if(inQ && next==='"'){ field+='"'; i++; }
      else inQ = !inQ;
    }else if(ch===',' && !inQ){
      cur += field.trim() + '|';
      field = '';
    }else if(ch==='\n' && !inQ){
      cur += field.trim();
      rows.push(cur);
      cur = ''; field = '';
    }else field += ch;
  }
  if(field) cur += field.trim();
  if(cur) rows.push(cur);
  return rows;
}

/* --------------------------------------------------------------
   LOAD CSV
   -------------------------------------------------------------- */
fetch('decks_data_fixed.csv')
  .then(r=>r.text())
  .then(text=>{
    const rows = parseCSV(text).slice(1);
    data = rows.map(r=>{
      const c = r.split('|');
      const uuid = c[0].trim();
      const name = c[1].replace(/^"|"$/g,'').replace(/""/g,'"').trim();
      const set  = c[2].trim();
      const housesStr = c[3].trim();
      const sas = parseInt(c[4]);
      const cardsStr = c[8].trim();

      const houseList = housesStr.split(',').map(h=>h.trim().toLowerCase());
      houseList.forEach(h=>houses.add(h));
      sets.add(set);

      minSAS = Math.min(minSAS, sas);
      maxSAS = Math.max(maxSAS, sas);

      let cards = {};
      try{
        let s = cardsStr.replace(/^"|"$/g, '').trim();
        s = s.replace(/\\"/g, '"');
        s = s.replace(/""([^""]+)""(?=:|\s*\[)/g, '"$1"');
        if(s.startsWith('{') && s.endsWith('}')){
          cards = JSON.parse(s);
        }else{
          const re = /"([^"]+)":\s*\[([^\]]*)\]/g;
          let m;
          while((m=re.exec(s))!==null){
            const h = m[1].trim();
            const list = m[2].replace(/"/g,'').split(',').map(x=>x.trim()).filter(x=>x);
            cards[h] = list;
            houses.add(h.toLowerCase());
          }
        }
      }catch(e){
        console.warn('Card parse failed for', name, e);
        cards = {"ERROR":["Parse failed"]};
      }

      return {uuid,name,set,housesStr,houseList,sas,cards};
    });

    document.getElementById('selectBtn').disabled = false;
    document.getElementById('sasMinInput').placeholder = minSAS;
    document.getElementById('sasMaxInput').placeholder = maxSAS;

    fillFilters();
    applyFilters(); // Initial filter
  })
  .catch(err=>{
    console.error(err);
    document.getElementById('filterCount').innerHTML = `
      <span style="color:#ff5252">
        Failed to load <b>decks_data_fixed.csv</b>.
      </span>`;
  });

/* --------------------------------------------------------------
   FILTER UI
   -------------------------------------------------------------- */
function fillFilters(){
  const setSel = document.getElementById('sets');
  const houseSel = document.getElementById('houses');
  setSel.innerHTML = houseSel.innerHTML = '';

  [...sets].sort().forEach(s=>{
    const o=document.createElement('option');
    o.value=s; o.textContent=s;
    setSel.appendChild(o);
  });
  [...houses].sort().forEach(h=>{
    const o=document.createElement('option');
    o.value=h; o.textContent=h.charAt(0).toUpperCase()+h.slice(1);
    houseSel.appendChild(o);
  });
}

/* --------------------------------------------------------------
   APPLY FILTERS
   -------------------------------------------------------------- */
function applyFilters(){
  const minInput = document.getElementById('sasMinInput').value;
  const maxInput = document.getElementById('sasMaxInput').value;
  const min = minInput ? +minInput : minSAS;
  const max = maxInput ? +maxInput : maxSAS;
  const selSets = Array.from(document.getElementById('sets').selectedOptions).map(o=>o.value);
  const selHouses = Array.from(document.getElementById('houses').selectedOptions).map(o=>o.value.toLowerCase());

  filteredData = data.filter(d=>
    d.sas>=min && d.sas<=max &&
    (selSets.length===0 || selSets.includes(d.set)) &&
    (selHouses.length===0 || selHouses.every(h=>d.houseList.includes(h)))
  );

  document.getElementById('filterCount').textContent = `${filteredData.length} decks match filters`;
  populateDeckReview();
}

/* --------------------------------------------------------------
   DECK REVIEW – SHOW FILTERED DECKS
   -------------------------------------------------------------- */
function populateDeckReview(){
  const container = document.getElementById('deckReviewList');
  container.innerHTML = '';

  const sorted = [...filteredData].sort((a,b) => {
    if(a.set !== b.set) return a.set.localeCompare(b.set);
    return a.name.localeCompare(b.name);
  });

  sorted.forEach(d => {
    const hasErr = hasErrata(d);
    const item = document.createElement('div');
    item.className = 'deck-item';
    item.onclick = () => replaceUnpinnedDeck(d);
    item.innerHTML = `
      <h3>
        ${d.housesStr.split(', ').map(h => `<img src="icons/${h.toLowerCase().replace(' ', '-')}.png" class="house-logo" onerror="this.style.display='none'">`).join('')}
        ${d.name} ${hasErr ? '<span class="errata-tag">(Errata)</span>' : ''}
      </h3>
      <p>Set: ${d.set} | SAS: ${d.sas}</p>
      <p>Houses: ${d.housesStr}</p>
    `;
    container.appendChild(item);
  });
}

/* --------------------------------------------------------------
   REPLACE UNPINNED DECK
   -------------------------------------------------------------- */
function replaceUnpinnedDeck(deck) {
  if (pinnedDecks.length === 2) {
    showMessage("Unpin a deck first");
    return;
  }

  const slot = pinnedDecks.length === 0 ? 0 :
               pinnedDecks[0] === selectedDecks[0]?.uuid ? 1 : 0;

  selectedDecks[slot] = deck;
  renderSelectedDecks();
}

/* --------------------------------------------------------------
   RENDER SELECTED DECKS
   -------------------------------------------------------------- */
function renderSelectedDecks() {
  const out = document.getElementById('results');
  out.innerHTML = '';

  const num = +document.getElementById('numDecks').value;
  for (let i = 0; i < num; i++) {
    const d = selectedDecks[i];
    if (!d) {
      const placeholder = document.createElement('div');
      placeholder.className = 'deck';
      placeholder.innerHTML = `<div style="padding:20px;text-align:center;color:#666;font-style:italic;">Slot ${i+1}: No deck selected</div>`;
      out.appendChild(placeholder);
      continue;
    }

    const deckDiv = document.createElement('div');
    deckDiv.className = 'deck collapsed';
    deckDiv.dataset.uuid = d.uuid;

    const hasErr = hasErrata(d);
    const errataTag = hasErr ? '<span class="errata-tag">(Errata)</span>' : '';
    const isPinned = pinnedDecks.includes(d.uuid);
    const pinText = isPinned ? 'UNPIN' : 'PIN';

    deckDiv.innerHTML = `
      <div class="deck-header" onclick="toggleCollapse(this)">
        <div class="info">
          <h2>
            ${d.housesStr.split(', ').map(h => `<img src="icons/${h.toLowerCase().replace(' ', '-')}.png" class="house-logo" onerror="this.style.display='none'">`).join('')}
            ${d.name} ${errataTag}
          </h2>
          <p class="deck-info">Set: ${d.set} | SAS: ${d.sas} | Houses: ${d.housesStr}</p>
          <div class="links">
            <a href="https://decksofkeyforge.com/decks/${d.uuid}" target="_blank">Decks of Keyforge</a>
            <a href="https://www.keyforgegame.com/deck-details/${d.uuid}" target="_blank">Master Vault</a>
          </div>
        </div>
        <button class="pin-btn ${isPinned ? 'pinned' : ''}" onclick="event.stopPropagation(); togglePin('${d.uuid}')">${pinText}</button>
      </div>
      <div class="deck-content">
        <div class="houses-grid">
          ${Object.entries(d.cards).map(([house, cards]) => {
            const hKey = house.toLowerCase();
            const iconName = HOUSE_ICON_MAP[hKey] || 'default';
            return `
              <div class="house">
                <img src="icons/${iconName}.png" alt="${house}" onerror="this.src='icons/default.png'">
                <h3>${house} (${cards.length})</h3>
                <div class="house-cards">
                  ${cards.map(c => `
                    <div class="card">
                      ${ERRATA[c] ? `<span class="errata">${c}</span><br><small>${ERRATA[c].replace(/\n/g,'<br>')}</small>` : c}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;

    out.appendChild(deckDiv);
  }
}

/* --------------------------------------------------------------
   RANDOM SELECTION
   -------------------------------------------------------------- */
function pickDecks(){
  const num = +document.getElementById('numDecks').value;
  const diff = num===2 ? +document.getElementById('maxDiffInput').value : 0;

  if(filteredData.length < (num - pinnedDecks.length)){
    document.getElementById('results').innerHTML = `<p style="color:#ff5252;text-align:center;">Not enough decks (need ${num - pinnedDecks.length} more)</p>`;
    return;
  }

  const available = filteredData.filter(d => !pinnedDecks.includes(d.uuid));
  const toPick = num - pinnedDecks.length;

  let chosen = [];
  if(toPick === 1){
    chosen = [available[Math.floor(Math.random()*available.length)]];
  }else if(toPick === 2){
    let tries=0;
    while(tries<2000){
      const a=available[Math.floor(Math.random()*available.length)];
      const b=available[Math.floor(Math.random()*available.length)];
      if(a.uuid!==b.uuid && Math.abs(a.sas-b.sas)<=diff){
        chosen=[a,b];
        break;
      }
      tries++;
    }
    if(chosen.length===0){
      document.getElementById('results').innerHTML = `<p style="color:#ff5252">Could not find 2 decks within SAS diff ${diff}</p>`;
      return;
    }
  }

  // Fill slots
  let idx = 0;
  for(let i=0; i<num; i++){
    if(pinnedDecks.includes(selectedDecks[i]?.uuid)) continue;
    selectedDecks[i] = chosen[idx++] || null;
  }

  renderSelectedDecks();
}

/* --------------------------------------------------------------
   CHECK IF DECK HAS ERRATA
   -------------------------------------------------------------- */
function hasErrata(deck){
  for(const house in deck.cards){
    if(deck.cards[house].some(card => ERRATA[card])) return true;
  }
  return false;
}

/* --------------------------------------------------------------
   UI helpers
   -------------------------------------------------------------- */
function selectAll(id){ const s=document.getElementById(id); for(let o of s.options) o.selected=true; applyFilters(); }
function clearAll(id){ const s=document.getElementById(id); for(let o of s.options) o.selected=false; applyFilters(); }

document.getElementById('numDecks').addEventListener('change',()=>{
  document.getElementById('diffControl').style.display = 
    document.getElementById('numDecks').value==='2' ? 'block':'none';
});

/* Attach filter listeners */
document.getElementById('sasMinInput').addEventListener('input', applyFilters);
document.getElementById('sasMaxInput').addEventListener('input', applyFilters);
document.getElementById('sets').addEventListener('change', applyFilters);
document.getElementById('houses').addEventListener('change', applyFilters);
</script>
</body>
</html>
